import{r as ze,j as c,u as C,b as p,c as N,a as w,d as I}from"./chunks/jsx-dev-runtime-1WYTjGlm.js";const Be=Ne(),ue=document.querySelector("main.container"),fe=document.body.dataset.roomId;ue&&fe&&document.getElementById("roomView")&&ze(c(xe,{roomId:fe}),ue);function xe({roomId:r}){const[o,s]=C("初期化中..."),[d,y]=C(null),[h,me]=C(0),[R,Z]=C(null),[L,ee]=C({sent:0,total:0}),[O,ne]=C({got:0,total:0}),[P,te]=C(null),[we,j]=C(!1),v=p(d),re=p(h),ce=p(null),B=p(!1),m=p(null),E=p(null),S=p(new Map),k=p(null),se=p(null),G=p(null),K=p(!1),H=p([]),V=p(null),T=p(null),W=p([]),q=p(0),A=p(null);N(()=>{v.current=d},[d]),N(()=>{re.current=h},[h]),N(()=>{ce.current=R},[R]);const x=w(()=>{for(const i of S.current.values())i.sent=!1,i.sending=!1},[]),ge=w(()=>{ye(location.href)},[]),ve=w(()=>{ye(r)},[r]),be=w(i=>{i.preventDefault(),j(!0)},[]),Se=w(()=>{j(!1)},[]),Re=w(i=>{i.preventDefault(),j(!1);const a=i.dataTransfer?.files?.[0];a&&(B.current=!1,x(),Z(a))},[x]),Ce=w(i=>{const l=i.currentTarget.files?.[0];l&&(B.current=!1,x(),Z(l))},[x]),oe=w(async()=>{const i=T.current;if(!i)return;s("ファイル生成中..."),A.current&&URL.revokeObjectURL(A.current);const a=new Blob(W.current,{type:i.mime}),l=URL.createObjectURL(a);A.current=l,te({url:l,name:i.name,size:i.size}),s("受信完了")},[]),ie=w(async(i,a)=>{const l=i.dc;if(!l)return;const D=!!E.current,U={type:"meta",name:a.name,size:a.size,mime:a.type||"application/octet-stream",encrypted:D};g("[send] starting:",U.name,"size:",U.size,"peer:",i.peerId),l.send(JSON.stringify(U)),s("送信中..."),ee({sent:0,total:a.size});let M=0;l.bufferedAmountLowThreshold=4*1024*1024;const _=()=>new Promise(b=>{if(l.bufferedAmount<=l.bufferedAmountLowThreshold)return b();l.onbufferedamountlow=()=>{l.onbufferedamountlow=null,b()}}),Q=async b=>{const t=b.buffer.slice(b.byteOffset,b.byteOffset+b.byteLength);let e=t;D&&(e=await Ge(t,E.current)),l.send(e),M+=b.byteLength,ee({sent:M,total:a.size}),l.bufferedAmount>8*1024*1024&&await _()},X=16*1024;let $=0;for(;$<a.size;){const t=await a.slice($,$+X).arrayBuffer(),e=new Uint8Array(t);if(e.byteLength===0)break;await Q(e),$+=e.byteLength}l.send(JSON.stringify({type:"done"})),g("[send] completed, peer:",i.peerId),s("送信完了"),i.sent=!0,m.current&&z(m.current,{type:"transfer-done",peerId:i.peerId})},[]),F=w(async(i,a)=>{if(!B.current||i.sending||i.sent)return;const l=ce.current;if(!l)return;const D=i.dc;!D||D.readyState!=="open"||(g("[send] triggered:",a,"peer:",i.peerId),i.sending=!0,await ie(i,l),i.sending=!1)},[ie]),ae=w(i=>{for(const a of S.current.values())F(a,i)},[F]),De=w(async()=>{R&&(B.current=!0,ae("manual"))},[R,ae]);N(()=>((async()=>{s("シグナリング接続中...");const a=new URLSearchParams(location.hash.slice(1)).get("k");E.current=a?await je(He(a)):null;const l=await Me(r,Be);m.current=l;const D=(t,e)=>{e.binaryType="arraybuffer",e.onopen=()=>{g("[rtc] datachannel open (peer:",t.peerId+")"),s("データチャネル準備完了"),F(t,"datachannel-open")},e.onclose=()=>{g("[rtc] datachannel close (peer:",t.peerId+")")},e.onerror=()=>{console.warn("[rtc] datachannel error (peer:",t.peerId+")")}},U=t=>{const e=S.current.get(t);if(e)return e;const n=new RTCPeerConnection({iceServers:[{urls:"stun:stun.cloudflare.com:3478"}]}),u={peerId:t,pc:n,dc:null,signalSid:0,activeSid:null,remoteDescSet:!1,pendingCandidates:[],offerInFlight:!1,sending:!1,sent:!1};n.onicecandidate=de=>{if(!de.candidate)return;const le=u.activeSid;le!=null&&m.current&&z(m.current,{type:"candidate",to:u.peerId,sid:le,candidate:de.candidate.toJSON()})},n.onconnectionstatechange=()=>{g("[rtc] connectionState:",n.connectionState,"(peer:",u.peerId+")")};const f=n.createDataChannel("file",{ordered:!0});return u.dc=f,D(u,f),S.current.set(t,u),u},M=t=>{const e=S.current.get(t);e&&(e.dc?.close(),e.pc.close(),S.current.delete(t))},_=async t=>{const e=t.pendingCandidates;let n=0;for(;n<e.length;){const u=e[n];if(u.sid!==t.activeSid){e.splice(n,1);continue}e.splice(n,1),await t.pc.addIceCandidate(u.candidate)}},Q=async t=>{if(t.offerInFlight||t.pc.signalingState!=="stable")return;t.offerInFlight=!0;const e=++t.signalSid;t.activeSid=e;const n=await t.pc.createOffer({iceRestart:!0});await t.pc.setLocalDescription(n),m.current&&z(m.current,{type:"offer",to:t.peerId,sid:e,sdp:t.pc.localDescription}),t.offerInFlight=!1},X=t=>{t.binaryType="arraybuffer",t.onopen=()=>{g("[rtc] datachannel open (receiver)"),s("データチャネル準備完了")},t.onclose=()=>{g("[rtc] datachannel close (receiver)"),s("データチャネル切断")},t.onerror=()=>{console.warn("[rtc] datachannel error (receiver)"),s("データチャネルエラー")},t.onmessage=async e=>{if(typeof e.data=="string"){const f=pe(e.data);if(!f)return;if(f.type==="meta"){if(g("[recv] starting:",f.name,"size:",f.size),T.current=f,W.current=[],q.current=0,te(null),ne({got:0,total:f.size}),f.encrypted&&!E.current){s("暗号化リンクの鍵が見つかりません（#k=... が必要）");return}s(`受信中: ${f.name}`)}f.type==="done"&&(g("[recv] completed"),await oe());return}if(!T.current)return;const n=await Je(e.data);let u=n;T.current.encrypted&&(u=await Ke(n,E.current)),W.current.push(new Uint8Array(u)),q.current+=u.byteLength,ne({got:q.current,total:T.current.size})}},$=t=>{if(k.current)return k.current;const e=new RTCPeerConnection({iceServers:[{urls:"stun:stun.cloudflare.com:3478"}]});return k.current=e,G.current=t,K.current=!1,H.current=[],e.onicecandidate=n=>{if(!n.candidate)return;const u=V.current,f=G.current;u==null||!f||!m.current||z(m.current,{type:"candidate",to:f,sid:u,candidate:n.candidate.toJSON()})},e.onconnectionstatechange=()=>{g("[rtc] connectionState:",e.connectionState,"(receiver)")},e.ondatachannel=n=>{se.current=n.channel,X(n.channel)},e},b=async()=>{const t=k.current,e=V.current;if(!t||e==null)return;const n=H.current;let u=0;for(;u<n.length;){const f=n[u];if(f.sid!==e){n.splice(u,1);continue}n.splice(u,1),await t.addIceCandidate(f.candidate)}};l.onmessage=async t=>{const e=pe(t.data);if(e){if(g("[ws] message:",e.type,"(role:",v.current+")"),e.type==="role"){v.current=e.role,y(e.role),e.role==="offerer"?s("送信側として待機中..."):s("受信側として待機中...");return}if(e.type==="peers"){re.current=e.count,me(e.count);return}if(e.type==="wait"){v.current==="answerer"&&s("順番待ち...");return}if(e.type==="start"){if(v.current==="offerer"&&e.peerId){const n=U(e.peerId);await Q(n);return}v.current==="answerer"&&s("接続準備中...");return}if(e.type==="peer-left"){v.current==="offerer"&&M(e.peerId);return}if(e.type==="offer"){if(v.current!=="answerer")return;const n=$(e.from);V.current=e.sid,await n.setRemoteDescription(e.sdp),K.current=!0,await b();const u=await n.createAnswer();await n.setLocalDescription(u),m.current&&z(m.current,{type:"answer",to:e.from,sid:e.sid,sdp:n.localDescription});return}if(e.type==="answer"){if(v.current!=="offerer")return;const n=S.current.get(e.from);if(!n||n.activeSid==null||e.sid!==n.activeSid)return;await n.pc.setRemoteDescription(e.sdp),n.remoteDescSet=!0,await _(n);return}if(e.type==="candidate"){if(v.current==="offerer"){const n=S.current.get(e.from);if(!n||n.activeSid==null||e.sid!==n.activeSid)return;n.remoteDescSet?await n.pc.addIceCandidate(e.candidate):n.pendingCandidates.push({sid:e.sid,candidate:e.candidate});return}if(v.current==="answerer"){if(e.from!==G.current)return;const n=k.current;if(!n)return;K.current?await n.addIceCandidate(e.candidate):H.current.push({sid:e.sid,candidate:e.candidate})}}}},l.onclose=()=>s("シグナリング切断"),l.onerror=()=>console.warn("[ws] error")})().catch(a=>{s(`エラー: ${String(a?.message||a)}`)}),()=>{m.current?.close(),se.current?.close(),k.current?.close();for(const a of S.current.values())a.dc?.close(),a.pc.close();S.current.clear(),A.current&&(URL.revokeObjectURL(A.current),A.current=null)}),[r,oe,F]);const Ie=I(()=>d==="offerer"?"送信側（offerer）":d==="answerer"?"受信側（answerer）":"—",[d]),Le=I(()=>String(h),[h]),Oe=I(()=>Y(L.sent,L.total),[L]),Pe=I(()=>he(L.sent,L.total),[L]),ke=I(()=>Y(O.got,O.total),[O]),Ae=I(()=>he(O.got,O.total),[O]),$e=I(()=>R?`${R.name} (${J(R.size)})`:"",[R]),Ee=d==="offerer"&&!!R,Te=d==="offerer",Ue=d==="answerer";return c("section",{id:"roomView",class:"card room",children:[c("div",{class:"roomHeader",children:[c("div",{class:"roomTitle",children:[c("div",{class:"eyebrow",children:"ROOM—SESSION"}),c("h2",{children:["ROOM ",c("span",{id:"roomIdLabel",class:"mono",children:r})]}),c("div",{id:"status",class:"status",children:o})]}),c("div",{class:"right",children:[c("button",{id:"copyLinkBtn",class:"btn",onClick:ge,children:"LINK"}),c("button",{id:"copyCodeBtn",class:"btn",onClick:ve,children:"CODE"})]})]}),c("div",{class:"roomGrid",children:[c("div",{class:"roomSide",children:[c("div",{class:"kv",children:[c("div",{class:"k",children:"ROLE"}),c("div",{class:"v",id:"roleLabel",children:Ie}),c("div",{class:"k",children:"PEERS"}),c("div",{class:"v",id:"peersLabel",children:Le})]}),c("div",{class:"sideCard muted small",children:"暗号化ONの場合、リンクの「#」以降に復号鍵が含まれます（サーバには送られません）。"})]}),c("div",{class:"roomMain",children:[c("div",{id:"senderPane",class:`pane${Te?"":" hidden"}`,children:[c("div",{id:"drop",class:`drop${we?" hover":""}`,onDragOver:be,onDragLeave:Se,onDrop:Re,children:[c("div",{class:"dropTitle",children:"DROP FILE HERE"}),c("div",{class:"muted small",children:"または"}),c("label",{class:"btn",children:["SELECT",c("input",{id:"fileInput",type:"file",hidden:!0,onChange:Ce})]})]}),c("div",{class:"row gap wrap",children:[c("button",{id:"sendBtn",class:"btn primary",disabled:!Ee,onClick:De,children:"SEND"}),c("div",{class:"muted small",id:"fileInfo",children:$e})]}),c("div",{class:"progress",children:[c("div",{class:"bar",children:c("div",{id:"sendBar",class:"fill",style:{width:`${Oe}%`}})}),c("div",{class:"muted small",id:"sendText",children:Pe})]})]}),c("div",{id:"receiverPane",class:`pane${Ue?"":" hidden"}`,children:[c("div",{class:"muted",children:"送信側がファイルを選ぶのを待っています..."}),c("div",{class:"progress",children:[c("div",{class:"bar",children:c("div",{id:"recvBar",class:"fill",style:{width:`${ke}%`}})}),c("div",{class:"muted small",id:"recvText",children:Ae})]}),c("div",{id:"downloadArea",class:P?"":"hidden",children:[c("a",{id:"downloadLink",class:"btn primary",href:P?.url??"#",download:P?.name,children:"DOWNLOAD"}),c("div",{id:"downloadMeta",class:"muted small",children:P?`${P.name} (${J(P.size)})`:""})]})]})]})]})]})}function Fe(r){return`${location.protocol==="https:"?"wss:":"ws:"}//${location.host}${r}`}function Me(r,o){return new Promise((s,d)=>{const y=new URL(Fe(`/ws/${r}`));y.searchParams.set("cid",o);const h=new WebSocket(y.toString());h.onopen=()=>s(h),h.onerror=()=>d(new Error("WebSocket接続に失敗しました"))})}function z(r,o){r.send(JSON.stringify(o))}function pe(r){try{return JSON.parse(r)}catch{return null}}function g(...r){const s=new Date().toISOString().slice(11,23);console.info(`[${s}]`,...r)}function Y(r,o){return o?Math.floor(r/o*100):0}function he(r,o){return o?`${Y(r,o)}% (${J(r)} / ${J(o)})`:"0%"}async function ye(r){try{await navigator.clipboard.writeText(r)}catch{const o=document.createElement("textarea");o.value=r,document.body.appendChild(o),o.select(),document.execCommand("copy"),o.remove()}}function J(r){const o=["B","KB","MB","GB"];let s=0,d=r;for(;d>=1024&&s<o.length-1;)d/=1024,s++;return`${d.toFixed(s===0?0:1)} ${o[s]}`}function Ne(){const r="share-files-client-id",o=localStorage.getItem(r);if(o)return o;const s=crypto.randomUUID();return localStorage.setItem(r,s),s}async function Je(r){return r instanceof ArrayBuffer?r:r.arrayBuffer()}async function je(r){return crypto.subtle.importKey("raw",r,{name:"AES-GCM"},!1,["encrypt","decrypt"])}async function Ge(r,o){if(!o)return r;const s=crypto.getRandomValues(new Uint8Array(12)),d=await crypto.subtle.encrypt({name:"AES-GCM",iv:s},o,r),y=new Uint8Array(12+d.byteLength);return y.set(s,0),y.set(new Uint8Array(d),12),y.buffer}async function Ke(r,o){if(!o)return r;const s=new Uint8Array(r),d=s.slice(0,12),y=s.slice(12);return await crypto.subtle.decrypt({name:"AES-GCM",iv:d},o,y)}function He(r){const o="=".repeat((4-r.length%4)%4),s=(r+o).replace(/-/g,"+").replace(/_/g,"/"),d=atob(s),y=new Uint8Array(d.length);for(let h=0;h<d.length;h++)y[h]=d.charCodeAt(h);return y}
//# sourceMappingURL=room.js.map
