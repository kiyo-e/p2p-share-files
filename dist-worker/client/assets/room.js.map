{"version":3,"file":"room.js","sources":["../../src/client/room.tsx"],"sourcesContent":["/** @jsxImportSource hono/jsx/dom */\n/**\n * Room client app for share-files.\n * See README.md; pairs with src/ui/room.tsx.\n */\n\nimport { render, useCallback, useEffect, useMemo, useRef, useState } from \"hono/jsx/dom\";\n\ntype RoomRole = \"offerer\" | \"answerer\" | null;\n\ntype RoomMessage =\n  | { type: \"role\"; role: \"offerer\" | \"answerer\"; cid: string }\n  | { type: \"peers\"; count: number }\n  | { type: \"wait\"; position?: number }\n  | { type: \"start\"; peerId?: string }\n  | { type: \"peer-left\"; peerId: string }\n  | { type: \"offer\"; from: string; sid: number; sdp: RTCSessionDescriptionInit }\n  | { type: \"answer\"; from: string; sid: number; sdp: RTCSessionDescriptionInit }\n  | { type: \"candidate\"; from: string; sid: number; candidate: RTCIceCandidateInit };\n\ntype SignalOut =\n  | { type: \"offer\"; to: string; sid: number; sdp: RTCSessionDescriptionInit }\n  | { type: \"answer\"; to: string; sid: number; sdp: RTCSessionDescriptionInit }\n  | { type: \"candidate\"; to: string; sid: number; candidate: RTCIceCandidateInit };\n\ntype ClientMessage = SignalOut | { type: \"transfer-done\"; peerId: string };\n\ntype IncomingMeta = {\n  type: \"meta\";\n  name: string;\n  size: number;\n  mime: string;\n  encrypted: boolean;\n};\n\ntype DoneMessage = { type: \"done\" };\n\ntype DataMessage = IncomingMeta | DoneMessage;\n\ntype OutgoingMeta = IncomingMeta;\n\ntype PendingCandidate = { sid: number; candidate: RTCIceCandidateInit };\n\ntype AnyWebSocket = WebSocket;\n\ntype DataChannel = RTCDataChannel;\n\ntype BufferLike = ArrayBuffer | Blob;\n\ntype RoomCryptoKey = CryptoKey | null;\n\ntype DownloadInfo = {\n  url: string;\n  name: string;\n  size: number;\n};\n\ntype OffererPeer = {\n  peerId: string;\n  pc: RTCPeerConnection;\n  dc: DataChannel | null;\n  signalSid: number;\n  activeSid: number | null;\n  remoteDescSet: boolean;\n  pendingCandidates: PendingCandidate[];\n  offerInFlight: boolean;\n  sending: boolean;\n  sent: boolean;\n};\n\nconst clientId = getClientId();\n\nconst root = document.querySelector(\"main.container\");\nconst roomId = document.body.dataset.roomId;\nif (root && roomId && document.getElementById(\"roomView\")) {\n  render(<RoomApp roomId={roomId} />, root);\n}\n\ntype RoomAppProps = {\n  roomId: string;\n};\n\nfunction RoomApp({ roomId }: RoomAppProps) {\n  const [status, setStatus] = useState(\"初期化中...\");\n  const [role, setRole] = useState<RoomRole>(null);\n  const [peers, setPeers] = useState(0);\n  const [selectedFile, setSelectedFile] = useState<File | null>(null);\n  const [sendProgress, setSendProgress] = useState({ sent: 0, total: 0 });\n  const [recvProgress, setRecvProgress] = useState({ got: 0, total: 0 });\n  const [download, setDownload] = useState<DownloadInfo | null>(null);\n  const [dropHover, setDropHover] = useState(false);\n\n  const roleRef = useRef<RoomRole>(role);\n  const peersRef = useRef(peers);\n  const selectedFileRef = useRef<File | null>(null);\n  const sendIntentRef = useRef(false);\n  const wsRef = useRef<AnyWebSocket | null>(null);\n  const cryptoKeyRef = useRef<RoomCryptoKey>(null);\n\n  const offererPeersRef = useRef<Map<string, OffererPeer>>(new Map());\n\n  const receiverPcRef = useRef<RTCPeerConnection | null>(null);\n  const receiverDcRef = useRef<DataChannel | null>(null);\n  const receiverPeerIdRef = useRef<string | null>(null);\n  const receiverRemoteDescSetRef = useRef(false);\n  const receiverPendingCandidatesRef = useRef<PendingCandidate[]>([]);\n  const receiverActiveSidRef = useRef<number | null>(null);\n\n  const incomingMetaRef = useRef<IncomingMeta | null>(null);\n  const recvChunksRef = useRef<Uint8Array[]>([]);\n  const recvBytesRef = useRef(0);\n  const downloadUrlRef = useRef<string | null>(null);\n\n  useEffect(() => {\n    roleRef.current = role;\n  }, [role]);\n\n  useEffect(() => {\n    peersRef.current = peers;\n  }, [peers]);\n\n  useEffect(() => {\n    selectedFileRef.current = selectedFile;\n  }, [selectedFile]);\n\n  const resetPeerSends = useCallback(() => {\n    for (const peer of offererPeersRef.current.values()) {\n      peer.sent = false;\n      peer.sending = false;\n    }\n  }, []);\n\n  const handleCopyLink = useCallback(() => {\n    copyText(location.href);\n  }, []);\n\n  const handleCopyCode = useCallback(() => {\n    copyText(roomId);\n  }, [roomId]);\n\n  const handleDragOver = useCallback((ev: DragEvent) => {\n    ev.preventDefault();\n    setDropHover(true);\n  }, []);\n\n  const handleDragLeave = useCallback(() => {\n    setDropHover(false);\n  }, []);\n\n  const handleDrop = useCallback((ev: DragEvent) => {\n    ev.preventDefault();\n    setDropHover(false);\n    const f = ev.dataTransfer?.files?.[0];\n    if (f) {\n      sendIntentRef.current = false;\n      resetPeerSends();\n      setSelectedFile(f);\n    }\n  }, [resetPeerSends]);\n\n  const handleFileInput = useCallback((ev: Event) => {\n    const input = ev.currentTarget as HTMLInputElement;\n    const f = input.files?.[0];\n    if (f) {\n      sendIntentRef.current = false;\n      resetPeerSends();\n      setSelectedFile(f);\n    }\n  }, [resetPeerSends]);\n\n  const finalizeDownload = useCallback(async () => {\n    const meta = incomingMetaRef.current;\n    if (!meta) return;\n    setStatus(\"ファイル生成中...\");\n\n    if (downloadUrlRef.current) {\n      URL.revokeObjectURL(downloadUrlRef.current);\n    }\n\n    const blob = new Blob(recvChunksRef.current, { type: meta.mime });\n    const url = URL.createObjectURL(blob);\n    downloadUrlRef.current = url;\n\n    setDownload({ url, name: meta.name, size: meta.size });\n    setStatus(\"受信完了\");\n  }, []);\n\n  const sendFileToPeer = useCallback(async (peer: OffererPeer, file: File) => {\n    const dc = peer.dc;\n    if (!dc) return;\n\n    const encrypted = !!cryptoKeyRef.current;\n    const meta: OutgoingMeta = {\n      type: \"meta\",\n      name: file.name,\n      size: file.size,\n      mime: file.type || \"application/octet-stream\",\n      encrypted,\n    };\n    log(\"[send] starting:\", meta.name, \"size:\", meta.size, \"peer:\", peer.peerId);\n    dc.send(JSON.stringify(meta));\n\n    setStatus(\"送信中...\");\n    setSendProgress({ sent: 0, total: file.size });\n\n    let sent = 0;\n\n    dc.bufferedAmountLowThreshold = 4 * 1024 * 1024;\n    const waitDrain = () =>\n      new Promise<void>((resolve) => {\n        if (dc.bufferedAmount <= dc.bufferedAmountLowThreshold) return resolve();\n        dc.onbufferedamountlow = () => {\n          dc.onbufferedamountlow = null;\n          resolve();\n        };\n      });\n\n    const sendChunk = async (value: Uint8Array) => {\n      const chunk = value.buffer.slice(value.byteOffset, value.byteOffset + value.byteLength);\n      let payload: ArrayBuffer = chunk;\n      if (encrypted) payload = await encryptChunk(chunk, cryptoKeyRef.current);\n      dc.send(payload);\n      sent += value.byteLength;\n      setSendProgress({ sent, total: file.size });\n      if (dc.bufferedAmount > 8 * 1024 * 1024) await waitDrain();\n    };\n\n    const chunkSize = 16 * 1024;\n    let offset = 0;\n    while (offset < file.size) {\n      const slice = file.slice(offset, offset + chunkSize);\n      const buf = await slice.arrayBuffer();\n      const value = new Uint8Array(buf);\n      if (value.byteLength === 0) break;\n      await sendChunk(value);\n      offset += value.byteLength;\n    }\n\n    dc.send(JSON.stringify({ type: \"done\" } satisfies DoneMessage));\n    log(\"[send] completed, peer:\", peer.peerId);\n    setStatus(\"送信完了\");\n    peer.sent = true;\n\n    if (wsRef.current) {\n      sendWS(wsRef.current, { type: \"transfer-done\", peerId: peer.peerId });\n    }\n  }, []);\n\n  const trySendPeer = useCallback(async (peer: OffererPeer, reason: string) => {\n    if (!sendIntentRef.current) return;\n    if (peer.sending || peer.sent) return;\n    const file = selectedFileRef.current;\n    if (!file) return;\n    const dc = peer.dc;\n    if (!dc || dc.readyState !== \"open\") return;\n\n    log(\"[send] triggered:\", reason, \"peer:\", peer.peerId);\n    peer.sending = true;\n    await sendFileToPeer(peer, file);\n    peer.sending = false;\n  }, [sendFileToPeer]);\n\n  const trySendAll = useCallback((reason: string) => {\n    for (const peer of offererPeersRef.current.values()) {\n      void trySendPeer(peer, reason);\n    }\n  }, [trySendPeer]);\n\n  const handleSend = useCallback(async () => {\n    if (!selectedFile) return;\n    sendIntentRef.current = true;\n    trySendAll(\"manual\");\n  }, [selectedFile, trySendAll]);\n\n  useEffect(() => {\n    const boot = async () => {\n      setStatus(\"シグナリング接続中...\");\n\n      const keyParam = new URLSearchParams(location.hash.slice(1)).get(\"k\");\n      cryptoKeyRef.current = keyParam ? await importAesKey(b64urlDecode(keyParam)) : null;\n\n      const ws = await connectSignaling(roomId, clientId);\n      wsRef.current = ws;\n\n      const wireOffererDataChannel = (peer: OffererPeer, ch: DataChannel) => {\n        ch.binaryType = \"arraybuffer\";\n        ch.onopen = () => {\n          log(\"[rtc] datachannel open (peer:\", peer.peerId + \")\");\n          setStatus(\"データチャネル準備完了\");\n          void trySendPeer(peer, \"datachannel-open\");\n        };\n        ch.onclose = () => {\n          log(\"[rtc] datachannel close (peer:\", peer.peerId + \")\");\n        };\n        ch.onerror = () => {\n          console.warn(\"[rtc] datachannel error (peer:\", peer.peerId + \")\");\n        };\n      };\n\n      const createOffererPeer = (peerId: string) => {\n        const existing = offererPeersRef.current.get(peerId);\n        if (existing) return existing;\n\n        const pc = new RTCPeerConnection({\n          iceServers: [{ urls: \"stun:stun.cloudflare.com:3478\" }],\n        });\n\n        const peer: OffererPeer = {\n          peerId,\n          pc,\n          dc: null,\n          signalSid: 0,\n          activeSid: null,\n          remoteDescSet: false,\n          pendingCandidates: [],\n          offerInFlight: false,\n          sending: false,\n          sent: false,\n        };\n\n        pc.onicecandidate = (ev) => {\n          if (!ev.candidate) return;\n          const sid = peer.activeSid;\n          if (sid == null) return;\n          if (!wsRef.current) return;\n          sendWS(wsRef.current, {\n            type: \"candidate\",\n            to: peer.peerId,\n            sid,\n            candidate: ev.candidate.toJSON(),\n          });\n        };\n\n        pc.onconnectionstatechange = () => {\n          log(\"[rtc] connectionState:\", pc.connectionState, \"(peer:\", peer.peerId + \")\");\n        };\n\n        const dc = pc.createDataChannel(\"file\", { ordered: true });\n        peer.dc = dc;\n        wireOffererDataChannel(peer, dc);\n\n        offererPeersRef.current.set(peerId, peer);\n        return peer;\n      };\n\n      const closeOffererPeer = (peerId: string) => {\n        const peer = offererPeersRef.current.get(peerId);\n        if (!peer) return;\n        peer.dc?.close();\n        peer.pc.close();\n        offererPeersRef.current.delete(peerId);\n      };\n\n      const flushOffererCandidates = async (peer: OffererPeer) => {\n        const pending = peer.pendingCandidates;\n        let i = 0;\n        while (i < pending.length) {\n          const item = pending[i];\n          if (item.sid !== peer.activeSid) {\n            pending.splice(i, 1);\n            continue;\n          }\n          pending.splice(i, 1);\n          await peer.pc.addIceCandidate(item.candidate);\n        }\n      };\n\n      const sendOffer = async (peer: OffererPeer) => {\n        if (peer.offerInFlight) return;\n        if (peer.pc.signalingState !== \"stable\") return;\n\n        peer.offerInFlight = true;\n        const sid = ++peer.signalSid;\n        peer.activeSid = sid;\n\n        const offer = await peer.pc.createOffer({ iceRestart: true });\n        await peer.pc.setLocalDescription(offer);\n        if (wsRef.current) {\n          sendWS(wsRef.current, { type: \"offer\", to: peer.peerId, sid, sdp: peer.pc.localDescription! });\n        }\n        peer.offerInFlight = false;\n      };\n\n      const wireReceiverDataChannel = (ch: DataChannel) => {\n        ch.binaryType = \"arraybuffer\";\n        ch.onopen = () => {\n          log(\"[rtc] datachannel open (receiver)\");\n          setStatus(\"データチャネル準備完了\");\n        };\n        ch.onclose = () => {\n          log(\"[rtc] datachannel close (receiver)\");\n          setStatus(\"データチャネル切断\");\n        };\n        ch.onerror = () => {\n          console.warn(\"[rtc] datachannel error (receiver)\");\n          setStatus(\"データチャネルエラー\");\n        };\n\n        ch.onmessage = async (ev) => {\n          if (typeof ev.data === \"string\") {\n            const m = safeJson(ev.data) as DataMessage | null;\n            if (!m) return;\n\n            if (m.type === \"meta\") {\n              log(\"[recv] starting:\", m.name, \"size:\", m.size);\n              incomingMetaRef.current = m;\n              recvChunksRef.current = [];\n              recvBytesRef.current = 0;\n              setDownload(null);\n              setRecvProgress({ got: 0, total: m.size });\n\n              if (m.encrypted && !cryptoKeyRef.current) {\n                setStatus(\"暗号化リンクの鍵が見つかりません（#k=... が必要）\");\n                return;\n              }\n              setStatus(`受信中: ${m.name}`);\n            }\n\n            if (m.type === \"done\") {\n              log(\"[recv] completed\");\n              await finalizeDownload();\n            }\n            return;\n          }\n\n          if (!incomingMetaRef.current) return;\n          const ab = await toArrayBuffer(ev.data as BufferLike);\n\n          let plain = ab;\n          if (incomingMetaRef.current.encrypted) {\n            plain = await decryptChunk(ab, cryptoKeyRef.current);\n          }\n          recvChunksRef.current.push(new Uint8Array(plain));\n          recvBytesRef.current += plain.byteLength;\n          setRecvProgress({ got: recvBytesRef.current, total: incomingMetaRef.current.size });\n        };\n      };\n\n      const createReceiverPc = (peerId: string) => {\n        if (receiverPcRef.current) return receiverPcRef.current;\n\n        const pc = new RTCPeerConnection({\n          iceServers: [{ urls: \"stun:stun.cloudflare.com:3478\" }],\n        });\n        receiverPcRef.current = pc;\n        receiverPeerIdRef.current = peerId;\n        receiverRemoteDescSetRef.current = false;\n        receiverPendingCandidatesRef.current = [];\n\n        pc.onicecandidate = (ev) => {\n          if (!ev.candidate) return;\n          const sid = receiverActiveSidRef.current;\n          const to = receiverPeerIdRef.current;\n          if (sid == null || !to || !wsRef.current) return;\n          sendWS(wsRef.current, {\n            type: \"candidate\",\n            to,\n            sid,\n            candidate: ev.candidate.toJSON(),\n          });\n        };\n\n        pc.onconnectionstatechange = () => {\n          log(\"[rtc] connectionState:\", pc.connectionState, \"(receiver)\");\n        };\n\n        pc.ondatachannel = (ev) => {\n          receiverDcRef.current = ev.channel;\n          wireReceiverDataChannel(ev.channel);\n        };\n\n        return pc;\n      };\n\n      const flushReceiverCandidates = async () => {\n        const pc = receiverPcRef.current;\n        const sid = receiverActiveSidRef.current;\n        if (!pc || sid == null) return;\n\n        const pending = receiverPendingCandidatesRef.current;\n        let i = 0;\n        while (i < pending.length) {\n          const item = pending[i];\n          if (item.sid !== sid) {\n            pending.splice(i, 1);\n            continue;\n          }\n          pending.splice(i, 1);\n          await pc.addIceCandidate(item.candidate);\n        }\n      };\n\n      ws.onmessage = async (ev) => {\n        const msg = safeJson(ev.data) as RoomMessage | null;\n        if (!msg) return;\n        log(\"[ws] message:\", msg.type, \"(role:\", roleRef.current + \")\");\n\n        if (msg.type === \"role\") {\n          roleRef.current = msg.role;\n          setRole(msg.role);\n          if (msg.role === \"offerer\") {\n            setStatus(\"送信側として待機中...\");\n          } else {\n            setStatus(\"受信側として待機中...\");\n          }\n          return;\n        }\n\n        if (msg.type === \"peers\") {\n          peersRef.current = msg.count;\n          setPeers(msg.count);\n          return;\n        }\n\n        if (msg.type === \"wait\") {\n          if (roleRef.current === \"answerer\") {\n            setStatus(\"順番待ち...\");\n          }\n          return;\n        }\n\n        if (msg.type === \"start\") {\n          if (roleRef.current === \"offerer\" && msg.peerId) {\n            const peer = createOffererPeer(msg.peerId);\n            await sendOffer(peer);\n            return;\n          }\n          if (roleRef.current === \"answerer\") {\n            setStatus(\"接続準備中...\");\n          }\n          return;\n        }\n\n        if (msg.type === \"peer-left\") {\n          if (roleRef.current === \"offerer\") {\n            closeOffererPeer(msg.peerId);\n          }\n          return;\n        }\n\n        if (msg.type === \"offer\") {\n          if (roleRef.current !== \"answerer\") return;\n          const pc = createReceiverPc(msg.from);\n          receiverActiveSidRef.current = msg.sid;\n          await pc.setRemoteDescription(msg.sdp);\n          receiverRemoteDescSetRef.current = true;\n          await flushReceiverCandidates();\n\n          const answer = await pc.createAnswer();\n          await pc.setLocalDescription(answer);\n          if (wsRef.current) {\n            sendWS(wsRef.current, {\n              type: \"answer\",\n              to: msg.from,\n              sid: msg.sid,\n              sdp: pc.localDescription!,\n            });\n          }\n          return;\n        }\n\n        if (msg.type === \"answer\") {\n          if (roleRef.current !== \"offerer\") return;\n          const peer = offererPeersRef.current.get(msg.from);\n          if (!peer) return;\n          if (peer.activeSid == null || msg.sid !== peer.activeSid) return;\n\n          await peer.pc.setRemoteDescription(msg.sdp);\n          peer.remoteDescSet = true;\n          await flushOffererCandidates(peer);\n          return;\n        }\n\n        if (msg.type === \"candidate\") {\n          if (roleRef.current === \"offerer\") {\n            const peer = offererPeersRef.current.get(msg.from);\n            if (!peer) return;\n            if (peer.activeSid == null || msg.sid !== peer.activeSid) return;\n\n            if (!peer.remoteDescSet) {\n              peer.pendingCandidates.push({ sid: msg.sid, candidate: msg.candidate });\n            } else {\n              await peer.pc.addIceCandidate(msg.candidate);\n            }\n            return;\n          }\n\n          if (roleRef.current === \"answerer\") {\n            if (msg.from !== receiverPeerIdRef.current) return;\n            const pc = receiverPcRef.current;\n            if (!pc) return;\n\n            if (!receiverRemoteDescSetRef.current) {\n              receiverPendingCandidatesRef.current.push({ sid: msg.sid, candidate: msg.candidate });\n            } else {\n              await pc.addIceCandidate(msg.candidate);\n            }\n          }\n        }\n      };\n\n      ws.onclose = () => setStatus(\"シグナリング切断\");\n      ws.onerror = () => console.warn(\"[ws] error\");\n    };\n\n    boot().catch((e) => {\n      setStatus(`エラー: ${String(e?.message || e)}`);\n    });\n\n    return () => {\n      wsRef.current?.close();\n      receiverDcRef.current?.close();\n      receiverPcRef.current?.close();\n      for (const peer of offererPeersRef.current.values()) {\n        peer.dc?.close();\n        peer.pc.close();\n      }\n      offererPeersRef.current.clear();\n      if (downloadUrlRef.current) {\n        URL.revokeObjectURL(downloadUrlRef.current);\n        downloadUrlRef.current = null;\n      }\n    };\n  }, [roomId, finalizeDownload, trySendPeer]);\n\n  const roleLabel = useMemo(() => {\n    if (role === \"offerer\") return \"送信側（offerer）\";\n    if (role === \"answerer\") return \"受信側（answerer）\";\n    return \"—\";\n  }, [role]);\n\n  const peersLabel = useMemo(() => String(peers), [peers]);\n\n  const sendPct = useMemo(\n    () => progressPercent(sendProgress.sent, sendProgress.total),\n    [sendProgress]\n  );\n  const sendText = useMemo(\n    () => progressText(sendProgress.sent, sendProgress.total),\n    [sendProgress]\n  );\n\n  const recvPct = useMemo(\n    () => progressPercent(recvProgress.got, recvProgress.total),\n    [recvProgress]\n  );\n  const recvText = useMemo(\n    () => progressText(recvProgress.got, recvProgress.total),\n    [recvProgress]\n  );\n\n  const selectedFileLabel = useMemo(() => {\n    if (!selectedFile) return \"\";\n    return `${selectedFile.name} (${formatBytes(selectedFile.size)})`;\n  }, [selectedFile]);\n\n  const canSend = role === \"offerer\" && !!selectedFile;\n  const showSender = role === \"offerer\";\n  const showReceiver = role === \"answerer\";\n\n  return (\n    <section id=\"roomView\" class=\"card room\">\n      <div class=\"roomHeader\">\n        <div class=\"roomTitle\">\n          <div class=\"eyebrow\">ROOM—SESSION</div>\n          <h2>\n            ROOM <span id=\"roomIdLabel\" class=\"mono\">{roomId}</span>\n          </h2>\n          <div id=\"status\" class=\"status\">{status}</div>\n        </div>\n        <div class=\"right\">\n          <button id=\"copyLinkBtn\" class=\"btn\" onClick={handleCopyLink}>LINK</button>\n          <button id=\"copyCodeBtn\" class=\"btn\" onClick={handleCopyCode}>CODE</button>\n        </div>\n      </div>\n\n      <div class=\"roomGrid\">\n        <div class=\"roomSide\">\n          <div class=\"kv\">\n            <div class=\"k\">ROLE</div>\n            <div class=\"v\" id=\"roleLabel\">{roleLabel}</div>\n            <div class=\"k\">PEERS</div>\n            <div class=\"v\" id=\"peersLabel\">{peersLabel}</div>\n          </div>\n          <div class=\"sideCard muted small\">\n            暗号化ONの場合、リンクの「#」以降に復号鍵が含まれます（サーバには送られません）。\n          </div>\n        </div>\n\n        <div class=\"roomMain\">\n          <div id=\"senderPane\" class={`pane${showSender ? \"\" : \" hidden\"}`}>\n            <div\n              id=\"drop\"\n              class={`drop${dropHover ? \" hover\" : \"\"}`}\n              onDragOver={handleDragOver}\n              onDragLeave={handleDragLeave}\n              onDrop={handleDrop}\n            >\n              <div class=\"dropTitle\">DROP FILE HERE</div>\n              <div class=\"muted small\">または</div>\n              <label class=\"btn\">\n                SELECT\n                <input id=\"fileInput\" type=\"file\" hidden onChange={handleFileInput} />\n              </label>\n            </div>\n\n            <div class=\"row gap wrap\">\n              <button id=\"sendBtn\" class=\"btn primary\" disabled={!canSend} onClick={handleSend}>\n                SEND\n              </button>\n              <div class=\"muted small\" id=\"fileInfo\">{selectedFileLabel}</div>\n            </div>\n\n            <div class=\"progress\">\n              <div class=\"bar\">\n                <div\n                  id=\"sendBar\"\n                  class=\"fill\"\n                  style={{ width: `${sendPct}%` }}\n                ></div>\n              </div>\n              <div class=\"muted small\" id=\"sendText\">{sendText}</div>\n            </div>\n          </div>\n\n          <div id=\"receiverPane\" class={`pane${showReceiver ? \"\" : \" hidden\"}`}>\n            <div class=\"muted\">送信側がファイルを選ぶのを待っています...</div>\n\n            <div class=\"progress\">\n              <div class=\"bar\">\n                <div\n                  id=\"recvBar\"\n                  class=\"fill\"\n                  style={{ width: `${recvPct}%` }}\n                ></div>\n              </div>\n              <div class=\"muted small\" id=\"recvText\">{recvText}</div>\n            </div>\n\n            <div id=\"downloadArea\" class={download ? \"\" : \"hidden\"}>\n              <a\n                id=\"downloadLink\"\n                class=\"btn primary\"\n                href={download?.url ?? \"#\"}\n                download={download?.name}\n              >\n                DOWNLOAD\n              </a>\n              <div id=\"downloadMeta\" class=\"muted small\">\n                {download ? `${download.name} (${formatBytes(download.size)})` : \"\"}\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n    </section>\n  );\n}\n\n/** ---------- signaling ---------- */\nfunction wsUrl(path: string) {\n  const proto = location.protocol === \"https:\" ? \"wss:\" : \"ws:\";\n  return `${proto}//${location.host}${path}`;\n}\n\nfunction connectSignaling(roomId: string, clientId: string) {\n  return new Promise<AnyWebSocket>((resolve, reject) => {\n    const url = new URL(wsUrl(`/ws/${roomId}`));\n    url.searchParams.set(\"cid\", clientId);\n    const ws = new WebSocket(url.toString());\n    ws.onopen = () => resolve(ws);\n    ws.onerror = () => reject(new Error(\"WebSocket接続に失敗しました\"));\n  });\n}\n\nfunction sendWS(ws: AnyWebSocket, obj: ClientMessage) {\n  ws.send(JSON.stringify(obj));\n}\n\nfunction safeJson(text: string) {\n  try {\n    return JSON.parse(text);\n  } catch {\n    return null;\n  }\n}\n\n/** タイムスタンプ付きログ */\nfunction log(...args: unknown[]) {\n  const now = new Date();\n  const ts = now.toISOString().slice(11, 23); // HH:mm:ss.SSS\n  console.info(`[${ts}]`, ...args);\n}\n\n/** ---------- UI helpers ---------- */\nfunction progressPercent(sent: number, total: number) {\n  return total ? Math.floor((sent / total) * 100) : 0;\n}\n\nfunction progressText(sent: number, total: number) {\n  if (!total) return \"0%\";\n  const pct = progressPercent(sent, total);\n  return `${pct}% (${formatBytes(sent)} / ${formatBytes(total)})`;\n}\n\nasync function copyText(s: string) {\n  try {\n    await navigator.clipboard.writeText(s);\n  } catch {\n    const ta = document.createElement(\"textarea\");\n    ta.value = s;\n    document.body.appendChild(ta);\n    ta.select();\n    document.execCommand(\"copy\");\n    ta.remove();\n  }\n}\n\nfunction formatBytes(n: number) {\n  const u = [\"B\", \"KB\", \"MB\", \"GB\"];\n  let i = 0;\n  let x = n;\n  while (x >= 1024 && i < u.length - 1) {\n    x /= 1024;\n    i++;\n  }\n  return `${x.toFixed(i === 0 ? 0 : 1)} ${u[i]}`;\n}\n\nfunction getClientId() {\n  const key = \"share-files-client-id\";\n  const stored = localStorage.getItem(key);\n  if (stored) return stored;\n  const id = crypto.randomUUID();\n  localStorage.setItem(key, id);\n  return id;\n}\n\nasync function toArrayBuffer(data: BufferLike) {\n  if (data instanceof ArrayBuffer) return data;\n  return data.arrayBuffer();\n}\n\n/** ---------- crypto (optional E2E) ---------- */\nasync function importAesKey(raw: Uint8Array) {\n  return crypto.subtle.importKey(\"raw\", raw, { name: \"AES-GCM\" }, false, [\n    \"encrypt\",\n    \"decrypt\",\n  ]);\n}\n\nasync function encryptChunk(plainAb: ArrayBuffer, key: RoomCryptoKey) {\n  if (!key) return plainAb;\n  const iv = crypto.getRandomValues(new Uint8Array(12));\n  const ct = await crypto.subtle.encrypt({ name: \"AES-GCM\", iv }, key, plainAb);\n  const out = new Uint8Array(12 + ct.byteLength);\n  out.set(iv, 0);\n  out.set(new Uint8Array(ct), 12);\n  return out.buffer;\n}\n\nasync function decryptChunk(frameAb: ArrayBuffer, key: RoomCryptoKey) {\n  if (!key) return frameAb;\n  const u8 = new Uint8Array(frameAb);\n  const iv = u8.slice(0, 12);\n  const ct = u8.slice(12);\n  const pt = await crypto.subtle.decrypt({ name: \"AES-GCM\", iv }, key, ct);\n  return pt;\n}\n\nfunction b64urlDecode(s: string) {\n  const pad = \"=\".repeat((4 - (s.length % 4)) % 4);\n  const b64 = (s + pad).replace(/-/g, \"+\").replace(/_/g, \"/\");\n  const bin = atob(b64);\n  const out = new Uint8Array(bin.length);\n  for (let i = 0; i < bin.length; i++) out[i] = bin.charCodeAt(i);\n  return out;\n}\n"],"names":["clientId","getClientId","root","roomId","render","jsx","RoomApp","status","setStatus","useState","role","setRole","peers","setPeers","selectedFile","setSelectedFile","sendProgress","setSendProgress","recvProgress","setRecvProgress","download","setDownload","dropHover","setDropHover","roleRef","useRef","peersRef","selectedFileRef","sendIntentRef","wsRef","cryptoKeyRef","offererPeersRef","receiverPcRef","receiverDcRef","receiverPeerIdRef","receiverRemoteDescSetRef","receiverPendingCandidatesRef","receiverActiveSidRef","incomingMetaRef","recvChunksRef","recvBytesRef","downloadUrlRef","useEffect","resetPeerSends","useCallback","peer","handleCopyLink","copyText","handleCopyCode","handleDragOver","ev","handleDragLeave","handleDrop","f","handleFileInput","finalizeDownload","meta","blob","url","sendFileToPeer","file","dc","encrypted","log","sent","waitDrain","resolve","sendChunk","value","chunk","payload","encryptChunk","chunkSize","offset","buf","sendWS","trySendPeer","reason","trySendAll","handleSend","keyParam","importAesKey","b64urlDecode","ws","connectSignaling","wireOffererDataChannel","ch","createOffererPeer","peerId","existing","pc","sid","closeOffererPeer","flushOffererCandidates","pending","i","item","sendOffer","offer","wireReceiverDataChannel","m","safeJson","ab","toArrayBuffer","plain","decryptChunk","createReceiverPc","to","flushReceiverCandidates","msg","answer","e","roleLabel","useMemo","peersLabel","sendPct","progressPercent","sendText","progressText","recvPct","recvText","selectedFileLabel","formatBytes","canSend","showSender","showReceiver","jsxs","wsUrl","path","reject","obj","text","args","ts","total","s","ta","n","u","x","key","stored","id","data","raw","plainAb","iv","ct","out","frameAb","u8","pad","b64","bin"],"mappings":"oGAsEA,MAAMA,GAAWC,GAAA,EAEXC,GAAO,SAAS,cAAc,gBAAgB,EAC9CC,GAAS,SAAS,KAAK,QAAQ,OACjCD,IAAQC,IAAU,SAAS,eAAe,UAAU,GACtDC,GAAOC,EAACC,GAAA,CAAQ,OAAAH,EAAA,CAAgB,EAAID,EAAI,EAO1C,SAASI,GAAQ,CAAE,OAAAH,GAAwB,CACzC,KAAM,CAACI,EAAQC,CAAS,EAAIC,EAAS,SAAS,EACxC,CAACC,EAAMC,CAAO,EAAIF,EAAmB,IAAI,EACzC,CAACG,EAAOC,EAAQ,EAAIJ,EAAS,CAAC,EAC9B,CAACK,EAAcC,CAAe,EAAIN,EAAsB,IAAI,EAC5D,CAACO,EAAcC,EAAe,EAAIR,EAAS,CAAE,KAAM,EAAG,MAAO,EAAG,EAChE,CAACS,EAAcC,EAAe,EAAIV,EAAS,CAAE,IAAK,EAAG,MAAO,EAAG,EAC/D,CAACW,EAAUC,EAAW,EAAIZ,EAA8B,IAAI,EAC5D,CAACa,GAAWC,CAAY,EAAId,EAAS,EAAK,EAE1Ce,EAAUC,EAAiBf,CAAI,EAC/BgB,GAAWD,EAAOb,CAAK,EACvBe,GAAkBF,EAAoB,IAAI,EAC1CG,EAAgBH,EAAO,EAAK,EAC5BI,EAAQJ,EAA4B,IAAI,EACxCK,EAAeL,EAAsB,IAAI,EAEzCM,EAAkBN,EAAiC,IAAI,GAAK,EAE5DO,EAAgBP,EAAiC,IAAI,EACrDQ,GAAgBR,EAA2B,IAAI,EAC/CS,EAAoBT,EAAsB,IAAI,EAC9CU,EAA2BV,EAAO,EAAK,EACvCW,EAA+BX,EAA2B,EAAE,EAC5DY,EAAuBZ,EAAsB,IAAI,EAEjDa,EAAkBb,EAA4B,IAAI,EAClDc,EAAgBd,EAAqB,EAAE,EACvCe,EAAef,EAAO,CAAC,EACvBgB,EAAiBhB,EAAsB,IAAI,EAEjDiB,EAAU,IAAM,CACdlB,EAAQ,QAAUd,CACpB,EAAG,CAACA,CAAI,CAAC,EAETgC,EAAU,IAAM,CACdhB,GAAS,QAAUd,CACrB,EAAG,CAACA,CAAK,CAAC,EAEV8B,EAAU,IAAM,CACdf,GAAgB,QAAUb,CAC5B,EAAG,CAACA,CAAY,CAAC,EAEjB,MAAM6B,EAAiBC,EAAY,IAAM,CACvC,UAAWC,KAAQd,EAAgB,QAAQ,OAAA,EACzCc,EAAK,KAAO,GACZA,EAAK,QAAU,EAEnB,EAAG,CAAA,CAAE,EAECC,GAAiBF,EAAY,IAAM,CACvCG,GAAS,SAAS,IAAI,CACxB,EAAG,CAAA,CAAE,EAECC,GAAiBJ,EAAY,IAAM,CACvCG,GAAS5C,CAAM,CACjB,EAAG,CAACA,CAAM,CAAC,EAEL8C,GAAiBL,EAAaM,GAAkB,CACpDA,EAAG,eAAA,EACH3B,EAAa,EAAI,CACnB,EAAG,CAAA,CAAE,EAEC4B,GAAkBP,EAAY,IAAM,CACxCrB,EAAa,EAAK,CACpB,EAAG,CAAA,CAAE,EAEC6B,GAAaR,EAAaM,GAAkB,CAChDA,EAAG,eAAA,EACH3B,EAAa,EAAK,EAClB,MAAM8B,EAAIH,EAAG,cAAc,QAAQ,CAAC,EAChCG,IACFzB,EAAc,QAAU,GACxBe,EAAA,EACA5B,EAAgBsC,CAAC,EAErB,EAAG,CAACV,CAAc,CAAC,EAEbW,GAAkBV,EAAaM,GAAc,CAEjD,MAAMG,EADQH,EAAG,cACD,QAAQ,CAAC,EACrBG,IACFzB,EAAc,QAAU,GACxBe,EAAA,EACA5B,EAAgBsC,CAAC,EAErB,EAAG,CAACV,CAAc,CAAC,EAEbY,GAAmBX,EAAY,SAAY,CAC/C,MAAMY,EAAOlB,EAAgB,QAC7B,GAAI,CAACkB,EAAM,OACXhD,EAAU,YAAY,EAElBiC,EAAe,SACjB,IAAI,gBAAgBA,EAAe,OAAO,EAG5C,MAAMgB,EAAO,IAAI,KAAKlB,EAAc,QAAS,CAAE,KAAMiB,EAAK,KAAM,EAC1DE,EAAM,IAAI,gBAAgBD,CAAI,EACpChB,EAAe,QAAUiB,EAEzBrC,GAAY,CAAE,IAAAqC,EAAK,KAAMF,EAAK,KAAM,KAAMA,EAAK,KAAM,EACrDhD,EAAU,MAAM,CAClB,EAAG,CAAA,CAAE,EAECmD,GAAiBf,EAAY,MAAOC,EAAmBe,IAAe,CAC1E,MAAMC,EAAKhB,EAAK,GAChB,GAAI,CAACgB,EAAI,OAET,MAAMC,EAAY,CAAC,CAAChC,EAAa,QAC3B0B,EAAqB,CACzB,KAAM,OACN,KAAMI,EAAK,KACX,KAAMA,EAAK,KACX,KAAMA,EAAK,MAAQ,2BACnB,UAAAE,CAAA,EAEFC,EAAI,mBAAoBP,EAAK,KAAM,QAASA,EAAK,KAAM,QAASX,EAAK,MAAM,EAC3EgB,EAAG,KAAK,KAAK,UAAUL,CAAI,CAAC,EAE5BhD,EAAU,QAAQ,EAClBS,GAAgB,CAAE,KAAM,EAAG,MAAO2C,EAAK,KAAM,EAE7C,IAAII,EAAO,EAEXH,EAAG,2BAA6B,EAAI,KAAO,KAC3C,MAAMI,EAAY,IAChB,IAAI,QAAeC,GAAY,CAC7B,GAAIL,EAAG,gBAAkBA,EAAG,kCAAmCK,EAAA,EAC/DL,EAAG,oBAAsB,IAAM,CAC7BA,EAAG,oBAAsB,KACzBK,EAAA,CACF,CACF,CAAC,EAEGC,EAAY,MAAOC,GAAsB,CAC7C,MAAMC,EAAQD,EAAM,OAAO,MAAMA,EAAM,WAAYA,EAAM,WAAaA,EAAM,UAAU,EACtF,IAAIE,EAAuBD,EACvBP,IAAWQ,EAAU,MAAMC,GAAaF,EAAOvC,EAAa,OAAO,GACvE+B,EAAG,KAAKS,CAAO,EACfN,GAAQI,EAAM,WACdnD,GAAgB,CAAE,KAAA+C,EAAM,MAAOJ,EAAK,KAAM,EACtCC,EAAG,eAAiB,EAAI,KAAO,YAAYI,EAAA,CACjD,EAEMO,EAAY,GAAK,KACvB,IAAIC,EAAS,EACb,KAAOA,EAASb,EAAK,MAAM,CAEzB,MAAMc,EAAM,MADEd,EAAK,MAAMa,EAAQA,EAASD,CAAS,EAC3B,YAAA,EAClBJ,EAAQ,IAAI,WAAWM,CAAG,EAChC,GAAIN,EAAM,aAAe,EAAG,MAC5B,MAAMD,EAAUC,CAAK,EACrBK,GAAUL,EAAM,UAClB,CAEAP,EAAG,KAAK,KAAK,UAAU,CAAE,KAAM,MAAA,CAA8B,CAAC,EAC9DE,EAAI,0BAA2BlB,EAAK,MAAM,EAC1CrC,EAAU,MAAM,EAChBqC,EAAK,KAAO,GAERhB,EAAM,SACR8C,EAAO9C,EAAM,QAAS,CAAE,KAAM,gBAAiB,OAAQgB,EAAK,OAAQ,CAExE,EAAG,CAAA,CAAE,EAEC+B,EAAchC,EAAY,MAAOC,EAAmBgC,IAAmB,CAE3E,GADI,CAACjD,EAAc,SACfiB,EAAK,SAAWA,EAAK,KAAM,OAC/B,MAAMe,EAAOjC,GAAgB,QAC7B,GAAI,CAACiC,EAAM,OACX,MAAMC,EAAKhB,EAAK,GACZ,CAACgB,GAAMA,EAAG,aAAe,SAE7BE,EAAI,oBAAqBc,EAAQ,QAAShC,EAAK,MAAM,EACrDA,EAAK,QAAU,GACf,MAAMc,GAAed,EAAMe,CAAI,EAC/Bf,EAAK,QAAU,GACjB,EAAG,CAACc,EAAc,CAAC,EAEbmB,GAAalC,EAAaiC,GAAmB,CACjD,UAAWhC,KAAQd,EAAgB,QAAQ,OAAA,EACpC6C,EAAY/B,EAAMgC,CAAM,CAEjC,EAAG,CAACD,CAAW,CAAC,EAEVG,GAAanC,EAAY,SAAY,CACpC9B,IACLc,EAAc,QAAU,GACxBkD,GAAW,QAAQ,EACrB,EAAG,CAAChE,EAAcgE,EAAU,CAAC,EAE7BpC,EAAU,MACK,SAAY,CACvBlC,EAAU,cAAc,EAExB,MAAMwE,EAAW,IAAI,gBAAgB,SAAS,KAAK,MAAM,CAAC,CAAC,EAAE,IAAI,GAAG,EACpElD,EAAa,QAAUkD,EAAW,MAAMC,GAAaC,GAAaF,CAAQ,CAAC,EAAI,KAE/E,MAAMG,EAAK,MAAMC,GAAiBjF,EAAQH,EAAQ,EAClD6B,EAAM,QAAUsD,EAEhB,MAAME,EAAyB,CAACxC,EAAmByC,IAAoB,CACrEA,EAAG,WAAa,cAChBA,EAAG,OAAS,IAAM,CAChBvB,EAAI,gCAAiClB,EAAK,OAAS,GAAG,EACtDrC,EAAU,aAAa,EAClBoE,EAAY/B,EAAM,kBAAkB,CAC3C,EACAyC,EAAG,QAAU,IAAM,CACjBvB,EAAI,iCAAkClB,EAAK,OAAS,GAAG,CACzD,EACAyC,EAAG,QAAU,IAAM,CACjB,QAAQ,KAAK,iCAAkCzC,EAAK,OAAS,GAAG,CAClE,CACF,EAEM0C,EAAqBC,GAAmB,CAC5C,MAAMC,EAAW1D,EAAgB,QAAQ,IAAIyD,CAAM,EACnD,GAAIC,EAAU,OAAOA,EAErB,MAAMC,EAAK,IAAI,kBAAkB,CAC/B,WAAY,CAAC,CAAE,KAAM,gCAAiC,CAAA,CACvD,EAEK7C,EAAoB,CACxB,OAAA2C,EACA,GAAAE,EACA,GAAI,KACJ,UAAW,EACX,UAAW,KACX,cAAe,GACf,kBAAmB,CAAA,EACnB,cAAe,GACf,QAAS,GACT,KAAM,EAAA,EAGRA,EAAG,eAAkBxC,IAAO,CAC1B,GAAI,CAACA,GAAG,UAAW,OACnB,MAAMyC,GAAM9C,EAAK,UACb8C,IAAO,MACN9D,EAAM,SACX8C,EAAO9C,EAAM,QAAS,CACpB,KAAM,YACN,GAAIgB,EAAK,OACT,IAAA8C,GACA,UAAWzC,GAAG,UAAU,OAAA,CAAO,CAChC,CACH,EAEAwC,EAAG,wBAA0B,IAAM,CACjC3B,EAAI,yBAA0B2B,EAAG,gBAAiB,SAAU7C,EAAK,OAAS,GAAG,CAC/E,EAEA,MAAMgB,EAAK6B,EAAG,kBAAkB,OAAQ,CAAE,QAAS,GAAM,EACzD,OAAA7C,EAAK,GAAKgB,EACVwB,EAAuBxC,EAAMgB,CAAE,EAE/B9B,EAAgB,QAAQ,IAAIyD,EAAQ3C,CAAI,EACjCA,CACT,EAEM+C,EAAoBJ,GAAmB,CAC3C,MAAM3C,EAAOd,EAAgB,QAAQ,IAAIyD,CAAM,EAC1C3C,IACLA,EAAK,IAAI,MAAA,EACTA,EAAK,GAAG,MAAA,EACRd,EAAgB,QAAQ,OAAOyD,CAAM,EACvC,EAEMK,EAAyB,MAAOhD,GAAsB,CAC1D,MAAMiD,EAAUjD,EAAK,kBACrB,IAAIkD,EAAI,EACR,KAAOA,EAAID,EAAQ,QAAQ,CACzB,MAAME,EAAOF,EAAQC,CAAC,EACtB,GAAIC,EAAK,MAAQnD,EAAK,UAAW,CAC/BiD,EAAQ,OAAOC,EAAG,CAAC,EACnB,QACF,CACAD,EAAQ,OAAOC,EAAG,CAAC,EACnB,MAAMlD,EAAK,GAAG,gBAAgBmD,EAAK,SAAS,CAC9C,CACF,EAEMC,EAAY,MAAOpD,GAAsB,CAE7C,GADIA,EAAK,eACLA,EAAK,GAAG,iBAAmB,SAAU,OAEzCA,EAAK,cAAgB,GACrB,MAAM8C,EAAM,EAAE9C,EAAK,UACnBA,EAAK,UAAY8C,EAEjB,MAAMO,EAAQ,MAAMrD,EAAK,GAAG,YAAY,CAAE,WAAY,GAAM,EAC5D,MAAMA,EAAK,GAAG,oBAAoBqD,CAAK,EACnCrE,EAAM,SACR8C,EAAO9C,EAAM,QAAS,CAAE,KAAM,QAAS,GAAIgB,EAAK,OAAQ,IAAA8C,EAAK,IAAK9C,EAAK,GAAG,iBAAmB,EAE/FA,EAAK,cAAgB,EACvB,EAEMsD,EAA2Bb,GAAoB,CACnDA,EAAG,WAAa,cAChBA,EAAG,OAAS,IAAM,CAChBvB,EAAI,mCAAmC,EACvCvD,EAAU,aAAa,CACzB,EACA8E,EAAG,QAAU,IAAM,CACjBvB,EAAI,oCAAoC,EACxCvD,EAAU,WAAW,CACvB,EACA8E,EAAG,QAAU,IAAM,CACjB,QAAQ,KAAK,oCAAoC,EACjD9E,EAAU,YAAY,CACxB,EAEA8E,EAAG,UAAY,MAAOpC,GAAO,CAC3B,GAAI,OAAOA,EAAG,MAAS,SAAU,CAC/B,MAAMkD,EAAIC,GAASnD,EAAG,IAAI,EAC1B,GAAI,CAACkD,EAAG,OAER,GAAIA,EAAE,OAAS,OAAQ,CAQrB,GAPArC,EAAI,mBAAoBqC,EAAE,KAAM,QAASA,EAAE,IAAI,EAC/C9D,EAAgB,QAAU8D,EAC1B7D,EAAc,QAAU,CAAA,EACxBC,EAAa,QAAU,EACvBnB,GAAY,IAAI,EAChBF,GAAgB,CAAE,IAAK,EAAG,MAAOiF,EAAE,KAAM,EAErCA,EAAE,WAAa,CAACtE,EAAa,QAAS,CACxCtB,EAAU,8BAA8B,EACxC,MACF,CACAA,EAAU,QAAQ4F,EAAE,IAAI,EAAE,CAC5B,CAEIA,EAAE,OAAS,SACbrC,EAAI,kBAAkB,EACtB,MAAMR,GAAA,GAER,MACF,CAEA,GAAI,CAACjB,EAAgB,QAAS,OAC9B,MAAMgE,EAAK,MAAMC,GAAcrD,EAAG,IAAkB,EAEpD,IAAIsD,EAAQF,EACRhE,EAAgB,QAAQ,YAC1BkE,EAAQ,MAAMC,GAAaH,EAAIxE,EAAa,OAAO,GAErDS,EAAc,QAAQ,KAAK,IAAI,WAAWiE,CAAK,CAAC,EAChDhE,EAAa,SAAWgE,EAAM,WAC9BrF,GAAgB,CAAE,IAAKqB,EAAa,QAAS,MAAOF,EAAgB,QAAQ,KAAM,CACpF,CACF,EAEMoE,EAAoBlB,GAAmB,CAC3C,GAAIxD,EAAc,QAAS,OAAOA,EAAc,QAEhD,MAAM0D,EAAK,IAAI,kBAAkB,CAC/B,WAAY,CAAC,CAAE,KAAM,gCAAiC,CAAA,CACvD,EACD,OAAA1D,EAAc,QAAU0D,EACxBxD,EAAkB,QAAUsD,EAC5BrD,EAAyB,QAAU,GACnCC,EAA6B,QAAU,CAAA,EAEvCsD,EAAG,eAAkBxC,GAAO,CAC1B,GAAI,CAACA,EAAG,UAAW,OACnB,MAAMyC,EAAMtD,EAAqB,QAC3BsE,EAAKzE,EAAkB,QACzByD,GAAO,MAAQ,CAACgB,GAAM,CAAC9E,EAAM,SACjC8C,EAAO9C,EAAM,QAAS,CACpB,KAAM,YACN,GAAA8E,EACA,IAAAhB,EACA,UAAWzC,EAAG,UAAU,OAAA,CAAO,CAChC,CACH,EAEAwC,EAAG,wBAA0B,IAAM,CACjC3B,EAAI,yBAA0B2B,EAAG,gBAAiB,YAAY,CAChE,EAEAA,EAAG,cAAiBxC,GAAO,CACzBjB,GAAc,QAAUiB,EAAG,QAC3BiD,EAAwBjD,EAAG,OAAO,CACpC,EAEOwC,CACT,EAEMkB,EAA0B,SAAY,CAC1C,MAAMlB,EAAK1D,EAAc,QACnB2D,EAAMtD,EAAqB,QACjC,GAAI,CAACqD,GAAMC,GAAO,KAAM,OAExB,MAAMG,EAAU1D,EAA6B,QAC7C,IAAI2D,EAAI,EACR,KAAOA,EAAID,EAAQ,QAAQ,CACzB,MAAME,EAAOF,EAAQC,CAAC,EACtB,GAAIC,EAAK,MAAQL,EAAK,CACpBG,EAAQ,OAAOC,EAAG,CAAC,EACnB,QACF,CACAD,EAAQ,OAAOC,EAAG,CAAC,EACnB,MAAML,EAAG,gBAAgBM,EAAK,SAAS,CACzC,CACF,EAEAb,EAAG,UAAY,MAAOjC,GAAO,CAC3B,MAAM2D,EAAMR,GAASnD,EAAG,IAAI,EAC5B,GAAK2D,EAGL,IAFA9C,EAAI,gBAAiB8C,EAAI,KAAM,SAAUrF,EAAQ,QAAU,GAAG,EAE1DqF,EAAI,OAAS,OAAQ,CACvBrF,EAAQ,QAAUqF,EAAI,KACtBlG,EAAQkG,EAAI,IAAI,EACZA,EAAI,OAAS,UACfrG,EAAU,cAAc,EAExBA,EAAU,cAAc,EAE1B,MACF,CAEA,GAAIqG,EAAI,OAAS,QAAS,CACxBnF,GAAS,QAAUmF,EAAI,MACvBhG,GAASgG,EAAI,KAAK,EAClB,MACF,CAEA,GAAIA,EAAI,OAAS,OAAQ,CACnBrF,EAAQ,UAAY,YACtBhB,EAAU,SAAS,EAErB,MACF,CAEA,GAAIqG,EAAI,OAAS,QAAS,CACxB,GAAIrF,EAAQ,UAAY,WAAaqF,EAAI,OAAQ,CAC/C,MAAMhE,EAAO0C,EAAkBsB,EAAI,MAAM,EACzC,MAAMZ,EAAUpD,CAAI,EACpB,MACF,CACIrB,EAAQ,UAAY,YACtBhB,EAAU,UAAU,EAEtB,MACF,CAEA,GAAIqG,EAAI,OAAS,YAAa,CACxBrF,EAAQ,UAAY,WACtBoE,EAAiBiB,EAAI,MAAM,EAE7B,MACF,CAEA,GAAIA,EAAI,OAAS,QAAS,CACxB,GAAIrF,EAAQ,UAAY,WAAY,OACpC,MAAMkE,EAAKgB,EAAiBG,EAAI,IAAI,EACpCxE,EAAqB,QAAUwE,EAAI,IACnC,MAAMnB,EAAG,qBAAqBmB,EAAI,GAAG,EACrC1E,EAAyB,QAAU,GACnC,MAAMyE,EAAA,EAEN,MAAME,EAAS,MAAMpB,EAAG,aAAA,EACxB,MAAMA,EAAG,oBAAoBoB,CAAM,EAC/BjF,EAAM,SACR8C,EAAO9C,EAAM,QAAS,CACpB,KAAM,SACN,GAAIgF,EAAI,KACR,IAAKA,EAAI,IACT,IAAKnB,EAAG,gBAAA,CACT,EAEH,MACF,CAEA,GAAImB,EAAI,OAAS,SAAU,CACzB,GAAIrF,EAAQ,UAAY,UAAW,OACnC,MAAMqB,EAAOd,EAAgB,QAAQ,IAAI8E,EAAI,IAAI,EAEjD,GADI,CAAChE,GACDA,EAAK,WAAa,MAAQgE,EAAI,MAAQhE,EAAK,UAAW,OAE1D,MAAMA,EAAK,GAAG,qBAAqBgE,EAAI,GAAG,EAC1ChE,EAAK,cAAgB,GACrB,MAAMgD,EAAuBhD,CAAI,EACjC,MACF,CAEA,GAAIgE,EAAI,OAAS,YAAa,CAC5B,GAAIrF,EAAQ,UAAY,UAAW,CACjC,MAAMqB,EAAOd,EAAgB,QAAQ,IAAI8E,EAAI,IAAI,EAEjD,GADI,CAAChE,GACDA,EAAK,WAAa,MAAQgE,EAAI,MAAQhE,EAAK,UAAW,OAErDA,EAAK,cAGR,MAAMA,EAAK,GAAG,gBAAgBgE,EAAI,SAAS,EAF3ChE,EAAK,kBAAkB,KAAK,CAAE,IAAKgE,EAAI,IAAK,UAAWA,EAAI,UAAW,EAIxE,MACF,CAEA,GAAIrF,EAAQ,UAAY,WAAY,CAClC,GAAIqF,EAAI,OAAS3E,EAAkB,QAAS,OAC5C,MAAMwD,EAAK1D,EAAc,QACzB,GAAI,CAAC0D,EAAI,OAEJvD,EAAyB,QAG5B,MAAMuD,EAAG,gBAAgBmB,EAAI,SAAS,EAFtCzE,EAA6B,QAAQ,KAAK,CAAE,IAAKyE,EAAI,IAAK,UAAWA,EAAI,UAAW,CAIxF,CACF,EACF,EAEA1B,EAAG,QAAU,IAAM3E,EAAU,UAAU,EACvC2E,EAAG,QAAU,IAAM,QAAQ,KAAK,YAAY,CAC9C,GAEA,EAAO,MAAO4B,GAAM,CAClBvG,EAAU,QAAQ,OAAOuG,GAAG,SAAWA,CAAC,CAAC,EAAE,CAC7C,CAAC,EAEM,IAAM,CACXlF,EAAM,SAAS,MAAA,EACfI,GAAc,SAAS,MAAA,EACvBD,EAAc,SAAS,MAAA,EACvB,UAAWa,KAAQd,EAAgB,QAAQ,OAAA,EACzCc,EAAK,IAAI,MAAA,EACTA,EAAK,GAAG,MAAA,EAEVd,EAAgB,QAAQ,MAAA,EACpBU,EAAe,UACjB,IAAI,gBAAgBA,EAAe,OAAO,EAC1CA,EAAe,QAAU,KAE7B,GACC,CAACtC,EAAQoD,GAAkBqB,CAAW,CAAC,EAE1C,MAAMoC,GAAYC,EAAQ,IACpBvG,IAAS,UAAkB,eAC3BA,IAAS,WAAmB,gBACzB,IACN,CAACA,CAAI,CAAC,EAEHwG,GAAaD,EAAQ,IAAM,OAAOrG,CAAK,EAAG,CAACA,CAAK,CAAC,EAEjDuG,GAAUF,EACd,IAAMG,EAAgBpG,EAAa,KAAMA,EAAa,KAAK,EAC3D,CAACA,CAAY,CAAA,EAETqG,GAAWJ,EACf,IAAMK,GAAatG,EAAa,KAAMA,EAAa,KAAK,EACxD,CAACA,CAAY,CAAA,EAGTuG,GAAUN,EACd,IAAMG,EAAgBlG,EAAa,IAAKA,EAAa,KAAK,EAC1D,CAACA,CAAY,CAAA,EAETsG,GAAWP,EACf,IAAMK,GAAapG,EAAa,IAAKA,EAAa,KAAK,EACvD,CAACA,CAAY,CAAA,EAGTuG,GAAoBR,EAAQ,IAC3BnG,EACE,GAAGA,EAAa,IAAI,KAAK4G,EAAY5G,EAAa,IAAI,CAAC,IADpC,GAEzB,CAACA,CAAY,CAAC,EAEX6G,GAAUjH,IAAS,WAAa,CAAC,CAACI,EAClC8G,GAAalH,IAAS,UACtBmH,GAAenH,IAAS,WAE9B,OACEoH,EAAC,UAAA,CAAQ,GAAG,WAAW,MAAM,YAC3B,SAAA,CAAAA,EAAC,MAAA,CAAI,MAAM,aACT,SAAA,CAAAA,EAAC,MAAA,CAAI,MAAM,YACT,SAAA,CAAAzH,EAAC,MAAA,CAAI,MAAM,UAAU,SAAA,eAAY,IAChC,KAAA,CAAG,SAAA,CAAA,UACI,OAAA,CAAK,GAAG,cAAc,MAAM,OAAQ,SAAAF,CAAAA,CAAO,CAAA,EACnD,IACC,MAAA,CAAI,GAAG,SAAS,MAAM,SAAU,SAAAI,CAAA,CAAO,CAAA,EAC1C,EACAuH,EAAC,MAAA,CAAI,MAAM,QACT,SAAA,CAAAzH,EAAC,UAAO,GAAG,cAAc,MAAM,MAAM,QAASyC,GAAgB,SAAA,MAAA,CAAI,EAClEzC,EAAC,UAAO,GAAG,cAAc,MAAM,MAAM,QAAS2C,GAAgB,SAAA,MAAA,CAAI,CAAA,CAAA,CACpE,CAAA,EACF,EAEA8E,EAAC,MAAA,CAAI,MAAM,WACT,SAAA,CAAAA,EAAC,MAAA,CAAI,MAAM,WACT,SAAA,CAAAA,EAAC,MAAA,CAAI,MAAM,KACT,SAAA,CAAAzH,EAAC,MAAA,CAAI,MAAM,IAAI,SAAA,OAAI,IAClB,MAAA,CAAI,MAAM,IAAI,GAAG,YAAa,SAAA2G,GAAU,EACzC3G,EAAC,MAAA,CAAI,MAAM,IAAI,SAAA,QAAK,IACnB,MAAA,CAAI,MAAM,IAAI,GAAG,aAAc,SAAA6G,EAAA,CAAW,CAAA,EAC7C,EACA7G,EAAC,MAAA,CAAI,MAAM,uBAAuB,SAAA,4CAAA,CAElC,CAAA,EACF,EAEAyH,EAAC,MAAA,CAAI,MAAM,WACT,SAAA,CAAAA,EAAC,MAAA,CAAI,GAAG,aAAa,MAAO,OAAOF,GAAa,GAAK,SAAS,GAC5D,SAAA,CAAAE,EAAC,MAAA,CACC,GAAG,OACH,MAAO,OAAOxG,GAAY,SAAW,EAAE,GACvC,WAAY2B,GACZ,YAAaE,GACb,OAAQC,GAER,SAAA,CAAA/C,EAAC,MAAA,CAAI,MAAM,YAAY,SAAA,iBAAc,EACrCA,EAAC,MAAA,CAAI,MAAM,cAAc,SAAA,MAAG,EAC5ByH,EAAC,QAAA,CAAM,MAAM,MAAM,SAAA,CAAA,SAEjBzH,EAAC,SAAM,GAAG,YAAY,KAAK,OAAO,OAAM,GAAC,SAAUiD,EAAA,CAAiB,CAAA,CAAA,CACtE,CAAA,CAAA,CAAA,EAGFwE,EAAC,MAAA,CAAI,MAAM,eACT,SAAA,CAAAzH,EAAC,SAAA,CAAO,GAAG,UAAU,MAAM,cAAc,SAAU,CAACsH,GAAS,QAAS5C,GAAY,SAAA,MAAA,CAElF,IACC,MAAA,CAAI,MAAM,cAAc,GAAG,WAAY,SAAA0C,EAAA,CAAkB,CAAA,EAC5D,EAEAK,EAAC,MAAA,CAAI,MAAM,WACT,SAAA,CAAAzH,EAAC,MAAA,CAAI,MAAM,MACT,SAAAA,EAAC,MAAA,CACC,GAAG,UACH,MAAM,OACN,MAAO,CAAE,MAAO,GAAG8G,EAAO,GAAA,CAAI,CAAA,EAElC,IACC,MAAA,CAAI,MAAM,cAAc,GAAG,WAAY,SAAAE,EAAA,CAAS,CAAA,CAAA,CACnD,CAAA,EACF,EAEAS,EAAC,OAAI,GAAG,eAAe,MAAO,OAAOD,GAAe,GAAK,SAAS,GAChE,SAAA,CAAAxH,EAAC,MAAA,CAAI,MAAM,QAAQ,SAAA,yBAAsB,EAEzCyH,EAAC,MAAA,CAAI,MAAM,WACT,SAAA,CAAAzH,EAAC,MAAA,CAAI,MAAM,MACT,SAAAA,EAAC,MAAA,CACC,GAAG,UACH,MAAM,OACN,MAAO,CAAE,MAAO,GAAGkH,EAAO,GAAA,CAAI,CAAA,EAElC,IACC,MAAA,CAAI,MAAM,cAAc,GAAG,WAAY,SAAAC,EAAA,CAAS,CAAA,EACnD,IAEC,MAAA,CAAI,GAAG,eAAe,MAAOpG,EAAW,GAAK,SAC5C,SAAA,CAAAf,EAAC,IAAA,CACC,GAAG,eACH,MAAM,cACN,KAAMe,GAAU,KAAO,IACvB,SAAUA,GAAU,KACrB,SAAA,UAAA,CAAA,IAGA,MAAA,CAAI,GAAG,eAAe,MAAM,cAC1B,SAAAA,EAAW,GAAGA,EAAS,IAAI,KAAKsG,EAAYtG,EAAS,IAAI,CAAC,IAAM,EAAA,CACnE,CAAA,CAAA,CACF,CAAA,CAAA,CACF,CAAA,CAAA,CACF,CAAA,CAAA,CACF,CAAA,EACF,CAEJ,CAGA,SAAS2G,GAAMC,EAAc,CAE3B,MAAO,GADO,SAAS,WAAa,SAAW,OAAS,KACzC,KAAK,SAAS,IAAI,GAAGA,CAAI,EAC1C,CAEA,SAAS5C,GAAiBjF,EAAgBH,EAAkB,CAC1D,OAAO,IAAI,QAAsB,CAACkE,EAAS+D,IAAW,CACpD,MAAMvE,EAAM,IAAI,IAAIqE,GAAM,OAAO5H,CAAM,EAAE,CAAC,EAC1CuD,EAAI,aAAa,IAAI,MAAO1D,CAAQ,EACpC,MAAMmF,EAAK,IAAI,UAAUzB,EAAI,UAAU,EACvCyB,EAAG,OAAS,IAAMjB,EAAQiB,CAAE,EAC5BA,EAAG,QAAU,IAAM8C,EAAO,IAAI,MAAM,oBAAoB,CAAC,CAC3D,CAAC,CACH,CAEA,SAAStD,EAAOQ,EAAkB+C,EAAoB,CACpD/C,EAAG,KAAK,KAAK,UAAU+C,CAAG,CAAC,CAC7B,CAEA,SAAS7B,GAAS8B,EAAc,CAC9B,GAAI,CACF,OAAO,KAAK,MAAMA,CAAI,CACxB,MAAQ,CACN,OAAO,IACT,CACF,CAGA,SAASpE,KAAOqE,EAAiB,CAE/B,MAAMC,MADU,KAAA,EACD,YAAA,EAAc,MAAM,GAAI,EAAE,EACzC,QAAQ,KAAK,IAAIA,CAAE,IAAK,GAAGD,CAAI,CACjC,CAGA,SAAShB,EAAgBpD,EAAcsE,EAAe,CACpD,OAAOA,EAAQ,KAAK,MAAOtE,EAAOsE,EAAS,GAAG,EAAI,CACpD,CAEA,SAAShB,GAAatD,EAAcsE,EAAe,CACjD,OAAKA,EAEE,GADKlB,EAAgBpD,EAAMsE,CAAK,CAC1B,MAAMZ,EAAY1D,CAAI,CAAC,MAAM0D,EAAYY,CAAK,CAAC,IAFzC,IAGrB,CAEA,eAAevF,GAASwF,EAAW,CACjC,GAAI,CACF,MAAM,UAAU,UAAU,UAAUA,CAAC,CACvC,MAAQ,CACN,MAAMC,EAAK,SAAS,cAAc,UAAU,EAC5CA,EAAG,MAAQD,EACX,SAAS,KAAK,YAAYC,CAAE,EAC5BA,EAAG,OAAA,EACH,SAAS,YAAY,MAAM,EAC3BA,EAAG,OAAA,CACL,CACF,CAEA,SAASd,EAAYe,EAAW,CAC9B,MAAMC,EAAI,CAAC,IAAK,KAAM,KAAM,IAAI,EAChC,IAAI3C,EAAI,EACJ4C,EAAIF,EACR,KAAOE,GAAK,MAAQ5C,EAAI2C,EAAE,OAAS,GACjCC,GAAK,KACL5C,IAEF,MAAO,GAAG4C,EAAE,QAAQ5C,IAAM,EAAI,EAAI,CAAC,CAAC,IAAI2C,EAAE3C,CAAC,CAAC,EAC9C,CAEA,SAAS9F,IAAc,CACrB,MAAM2I,EAAM,wBACNC,EAAS,aAAa,QAAQD,CAAG,EACvC,GAAIC,EAAQ,OAAOA,EACnB,MAAMC,EAAK,OAAO,WAAA,EAClB,oBAAa,QAAQF,EAAKE,CAAE,EACrBA,CACT,CAEA,eAAevC,GAAcwC,EAAkB,CAC7C,OAAIA,aAAgB,YAAoBA,EACjCA,EAAK,YAAA,CACd,CAGA,eAAe9D,GAAa+D,EAAiB,CAC3C,OAAO,OAAO,OAAO,UAAU,MAAOA,EAAK,CAAE,KAAM,SAAA,EAAa,GAAO,CACrE,UACA,SAAA,CACD,CACH,CAEA,eAAezE,GAAa0E,EAAsBL,EAAoB,CACpE,GAAI,CAACA,EAAK,OAAOK,EACjB,MAAMC,EAAK,OAAO,gBAAgB,IAAI,WAAW,EAAE,CAAC,EAC9CC,EAAK,MAAM,OAAO,OAAO,QAAQ,CAAE,KAAM,UAAW,GAAAD,GAAMN,EAAKK,CAAO,EACtEG,EAAM,IAAI,WAAW,GAAKD,EAAG,UAAU,EAC7C,OAAAC,EAAI,IAAIF,EAAI,CAAC,EACbE,EAAI,IAAI,IAAI,WAAWD,CAAE,EAAG,EAAE,EACvBC,EAAI,MACb,CAEA,eAAe3C,GAAa4C,EAAsBT,EAAoB,CACpE,GAAI,CAACA,EAAK,OAAOS,EACjB,MAAMC,EAAK,IAAI,WAAWD,CAAO,EAC3BH,EAAKI,EAAG,MAAM,EAAG,EAAE,EACnBH,EAAKG,EAAG,MAAM,EAAE,EAEtB,OADW,MAAM,OAAO,OAAO,QAAQ,CAAE,KAAM,UAAW,GAAAJ,GAAMN,EAAKO,CAAE,CAEzE,CAEA,SAASjE,GAAaqD,EAAW,CAC/B,MAAMgB,EAAM,IAAI,QAAQ,EAAKhB,EAAE,OAAS,GAAM,CAAC,EACzCiB,GAAOjB,EAAIgB,GAAK,QAAQ,KAAM,GAAG,EAAE,QAAQ,KAAM,GAAG,EACpDE,EAAM,KAAKD,CAAG,EACdJ,EAAM,IAAI,WAAWK,EAAI,MAAM,EACrC,QAAS1D,EAAI,EAAGA,EAAI0D,EAAI,OAAQ1D,IAAKqD,EAAIrD,CAAC,EAAI0D,EAAI,WAAW1D,CAAC,EAC9D,OAAOqD,CACT"}